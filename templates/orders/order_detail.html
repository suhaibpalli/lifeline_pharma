{% extends 'base.html' %}

{% block title %}Order #{{ order.order_number }} - {{ site_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- Order Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-3xl font-bold">Order #{{ order.order_number }}</h1>
                    <p class="text-gray-600 mt-2">
                        Placed on {{ order.created_at|date:"d M, Y \a\t H:i" }}
                    </p>
                </div>
                
                <div class="mt-4 md:mt-0 flex flex-col items-end space-y-2">
                    <span class="order-status status-{{ order.status|lower }} px-4 py-2 rounded-full font-medium">
                        {{ order.get_status_display }}
                    </span>
                    <span class="text-2xl font-bold text-blue-600">₹{{ order.total_amount }}</span>
                </div>
            </div>
            
            <!-- Order Actions -->
            <div class="mt-6 flex flex-wrap gap-3">
                {% if order.can_be_cancelled %}
                    <button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 cancel-order"
                            data-order-number="{{ order.order_number }}">
                        <i class="fas fa-times mr-2"></i>Cancel Order
                    </button>
                {% endif %}
                
                <a href="{% url 'orders:order_tracking' order_number=order.order_number %}" 
                   class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    <i class="fas fa-truck mr-2"></i>Track Order
                </a>
                
                <button class="border border-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-50" 
                        onclick="window.print()">
                    <i class="fas fa-print mr-2"></i>Print Invoice
                </button>
                
                {% if order.status == 'DELIVERED' %}
                    <a href="#" class="border border-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-50">
                        <i class="fas fa-undo mr-2"></i>Return/Exchange
                    </a>
                {% endif %}
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Order Details -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Order Items -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b">
                        <h2 class="text-xl font-semibold">Order Items</h2>
                    </div>
                    
                    <div class="divide-y">
                        {% for item in order.items.all %}
                            <div class="p-6 flex items-center space-x-4">
                                <!-- Product Image -->
                                {% if item.product.primary_image %}
                                    <img src="data:image/jpeg;base64,{{ item.product.primary_image.image_data }}" 
                                         alt="{{ item.product.name }}" 
                                         class="w-20 h-20 object-cover rounded">
                                {% else %}
                                    <div class="w-20 h-20 bg-gray-200 rounded flex items-center justify-center">
                                        <i class="fas fa-pills text-gray-400 text-xl"></i>
                                    </div>
                                {% endif %}
                                
                                <!-- Product Details -->
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg">
                                        <a href="{{ item.product.get_absolute_url }}" class="hover:text-blue-600">
                                            {{ item.product.name }}
                                        </a>
                                    </h3>
                                    <p class="text-gray-600">{{ item.product.manufacturer.name }}</p>
                                    {% if item.product.pack_size %}
                                        <p class="text-sm text-gray-500">{{ item.product.pack_size }}</p>
                                    {% endif %}
                                    
                                    <div class="mt-2 flex items-center space-x-4">
                                        <span class="text-sm text-gray-600">Qty: {{ item.quantity }}</span>
                                        <span class="text-sm text-gray-600">Price: ₹{{ item.price }} each</span>
                                    </div>
                                </div>
                                
                                <!-- Item Total -->
                                <div class="text-right">
                                    <p class="text-lg font-bold">₹{{ item.total_price }}</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Order Status Timeline -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-6">Order Timeline</h2>
                    
                    <div class="relative">
                        {% for status in order.status_history.all %}
                            <div class="flex items-start mb-6 last:mb-0">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-check text-white text-sm"></i>
                                </div>
                                
                                <div class="flex-1">
                                    <h3 class="font-medium">{{ status.get_status_display }}</h3>
                                    <p class="text-sm text-gray-600">{{ status.created_at|date:"d M, Y \a\t H:i" }}</p>
                                    {% if status.notes %}
                                        <p class="text-sm text-gray-700 mt-1">{{ status.notes }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if not forloop.last %}
                                <div class="w-0.5 h-8 bg-gray-200 ml-4 mb-2"></div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Prescription (if uploaded) -->
                {% if order.prescription_image %}
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Uploaded Prescription</h2>
                        <div class="border rounded-lg p-4">
                            <img src="data:image/jpeg;base64,{{ order.prescription_image }}" 
                                 alt="Prescription" 
                                 class="max-w-full h-auto rounded">
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Right Column - Order Summary & Info -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Order Summary -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Subtotal ({{ order.items.count }} items)</span>
                            <span>₹{{ order.subtotal }}</span>
                        </div>
                        
                        {% if order.tax_amount > 0 %}
                            <div class="flex justify-between">
                                <span>Tax</span>
                                <span>₹{{ order.tax_amount }}</span>
                            </div>
                        {% endif %}
                        
                        <div class="flex justify-between">
                            <span>Delivery Charges</span>
                            <span>
                                {% if order.delivery_charge > 0 %}
                                    ₹{{ order.delivery_charge }}
                                {% else %}
                                    <span class="text-green-600">FREE</span>
                                {% endif %}
                            </span>
                        </div>
                        
                        {% if order.discount_amount > 0 %}
                            <div class="flex justify-between text-green-600">
                                <span>Discount</span>
                                <span>-₹{{ order.discount_amount }}</span>
                            </div>
                        {% endif %}
                        
                        <hr class="my-3">
                        
                        <div class="flex justify-between text-lg font-bold">
                            <span>Total Amount</span>
                            <span class="text-blue-600">₹{{ order.total_amount }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Information -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Payment Information</h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Payment Method</span>
                            <span class="font-medium">{{ order.get_payment_method_display }}</span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span>Payment Status</span>
                            <span class="font-medium payment-status status-{{ order.payment_status|lower }}">
                                {{ order.get_payment_status_display }}
                            </span>
                        </div>
                        
                        {% if order.payment_id %}
                            <div class="flex justify-between">
                                <span>Transaction ID</span>
                                <span class="font-mono text-sm">{{ order.payment_id }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Delivery Information -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Delivery Information</h2>
                    
                    <div class="space-y-3">
                        <div>
                            <h3 class="font-medium">Delivery Address</h3>
                            <div class="text-sm text-gray-600 mt-1">
                                <p>{{ order.delivery_address.name }}</p>
                                <p>{{ order.delivery_address.address_line_1 }}</p>
                                {% if order.delivery_address.address_line_2 %}
                                    <p>{{ order.delivery_address.address_line_2 }}</p>
                                {% endif %}
                                <p>{{ order.delivery_address.city }}, {{ order.delivery_address.state }}</p>
                                <p>{{ order.delivery_address.pincode }}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-medium">Contact Number</h3>
                            <p class="text-sm text-gray-600">{{ order.delivery_phone }}</p>
                        </div>
                        
                        {% if order.estimated_delivery %}
                            <div>
                                <h3 class="font-medium">Estimated Delivery</h3>
                                <p class="text-sm text-gray-600">{{ order.estimated_delivery|date:"d M, Y" }}</p>
                            </div>
                        {% endif %}
                        
                        {% if order.tracking_number %}
                            <div>
                                <h3 class="font-medium">Tracking Details</h3>
                                <p class="text-sm text-gray-600">{{ order.tracking_number }}</p>
                                {% if order.courier_partner %}
                                    <p class="text-xs text-gray-500">{{ order.courier_partner }}</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Order Notes -->
                {% if order.notes %}
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Order Notes</h2>
                        <p class="text-gray-700">{{ order.notes }}</p>
                    </div>
                {% endif %}
                
                <!-- Need Help -->
                <div class="bg-blue-50 rounded-lg p-6">
                    <h2 class="text-lg font-semibold mb-3">Need Help?</h2>
                    <div class="space-y-2 text-sm">
                        <p>
                            <i class="fas fa-phone mr-2 text-blue-600"></i>
                            Call us: {{ site_phone|default:"+91-XXXXXXXXXX" }}
                        </p>
                        <p>
                            <i class="fas fa-envelope mr-2 text-blue-600"></i>
                            Email: {{ site_email|default:"support@example.com" }}
                        </p>
                        <p>
                            <i class="fas fa-clock mr-2 text-blue-600"></i>
                            Support: 9 AM - 8 PM
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.order-status, .payment-status {
    font-size: 0.75rem;
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
}

.status-pending { background-color: #fef3c7; color: #d97706; }
.status-confirmed { background-color: #dbeafe; color: #2563eb; }
.status-processing { background-color: #e0e7ff; color: #5b21b6; }
.status-shipped { background-color: #fce7f3; color: #be185d; }
.status-out_for_delivery { background-color: #fed7aa; color: #ea580c; }
.status-delivered { background-color: #dcfce7; color: #16a34a; }
.status-cancelled { background-color: #fee2e2; color: #dc2626; }
.status-returned { background-color: #f3f4f6; color: #6b7280; }
.status-paid { background-color: #dcfce7; color: #16a34a; }
.status-failed { background-color: #fee2e2; color: #dc2626; }
.status-refunded { background-color: #f3f4f6; color: #6b7280; }

@media print {
    .no-print { display: none !important; }
    body { background: white !important; }
    .container { max-width: none !important; margin: 0 !important; padding: 0 !important; }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/orders.js' %}"></script>
{% endblock %}
